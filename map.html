<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReDa Map (fixed)</title>

  <!-- Tailwind & font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

  <!-- Leaflet CSS (jsDelivr) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet.draw CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

  <!-- Geocoder CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />

  <style>
    html,body { height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; }
    #map { width:100%; height:100vh; }
    .map-topbar { position: absolute; left: 12px; top: 12px; z-index: 1000; }
    .map-topbar .p-2 { white-space: nowrap; overflow-x: auto; }
    .map-controls { position: absolute; right: 12px; top: 12px; z-index: 1000; display:flex; gap:8px; flex-direction:column; }
    .info-box { position:absolute; left:12px; bottom:12px; z-index:999; background:rgba(255,255,255,0.95); padding:12px 14px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,0.08); font-size:13px; max-width:280px; }
    .btn { background:#dc2626; color:white; padding:10px 14px; border-radius:8px; font-weight:600; border:none; cursor:pointer; font-size:13px; transition:all 0.2s ease; white-space:nowrap; flex-shrink:0; }
    .btn:hover { background:#b91c1c; transform:translateY(-1px); box-shadow:0 4px 12px rgba(220,38,38,0.3); }
    .btn.gray { background:#f3f4f6; color:#111827; }
    .btn.gray:hover { background:#e5e7eb; }
    
    /* Responsive adjustments */
    @media (max-width: 640px) {
      .map-topbar { left: 8px; top: 8px; }
      .map-topbar .p-2 { display:flex; flex-direction:column; gap:6px; }
      .btn { padding:8px 12px; font-size:12px; }
      .map-controls { right: 8px; top: 8px; }
      .info-box { left: 8px; bottom: 8px; max-width: calc(100vw - 32px); font-size:12px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="map-topbar">
    <div class="p-3 bg-white rounded-xl shadow-md flex gap-2 items-center flex-wrap">
      <button id="locate-btn" class="btn gray" title="Center on my location">üìç My Location</button>
      <button id="start-route-btn" class="btn" title="Start route planning">‚úèÔ∏è Draw Route</button>
      <button id="clear-btn" class="btn gray" title="Clear all routes">üóëÔ∏è Clear</button>
      <button id="export-geojson" class="btn gray" title="Export drawn routes as GeoJSON">üì• Export</button>
    </div>
  </div>

  <div class="map-controls">
    <div class="p-3 bg-white rounded-xl shadow-md text-sm" id="distance-box">
      <div><strong>üìè Distance</strong></div>
      <div class="text-red-600 font-bold text-lg" id="distance-val">0.00 km</div>
    </div>
  </div>

  <div class="info-box">
    <strong>üó∫Ô∏è Quick Tips:</strong>
    <ul class="mt-2 space-y-1 text-xs">
      <li>üîç Search locations in the top-left search box</li>
      <li>‚úèÔ∏è Click "Draw Route" and click on the map to draw</li>
      <li>üìå Double-click or press Enter to finish</li>
      <li>‚å®Ô∏è Press "R" key to toggle draw mode</li>
    </ul>
  </div>

  <!-- SCRIPTS in safe order (Leaflet first) -->
  <!-- Leaflet JS (jsDelivr) -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Draw -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Geocoder -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>

  <!-- Turf (jsDelivr) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    // Wait for DOM content
    document.addEventListener('DOMContentLoaded', () => {
      // quick checks
      console.log('Starting map init checks...');
      console.log('window.L (Leaflet) is', typeof window.L);
      console.log('window.turf is', typeof window.turf);

      if (typeof window.L === 'undefined') {
        const msg = 'Leaflet (L) not loaded. Check network/CDN or script order.';
        console.error(msg);
        alert(msg + ' See console for details.');
        return;
      }
      if (typeof window.turf === 'undefined') {
        console.warn('Turf not loaded ‚Äî distance calculations will fail.');
      }

      // initialize map
      const map = L.map('map', { zoomControl: true }).setView([20.5937,78.9629], 5);

      // tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Add geocoder control (safe to add now because L exists)
      try {
        L.Control.geocoder({ defaultMarkGeocode: true }).addTo(map);
      } catch (e) {
        console.error('Error adding geocoder control:', e);
      }

      // FeatureGroup for drawn items
      const drawnItems = new L.FeatureGroup().addTo(map);

      // Draw control config
      const drawOptions = {
        draw: {
          polyline: { shapeOptions: { color: '#dc2626', weight: 4 } },
          polygon: false,
          rectangle: false,
          circle: false,
          marker: true
        },
        edit: { featureGroup: drawnItems, remove: true }
      };

      // Edit control (only edit UI)
      const editControl = new L.Control.Draw({ draw: false, edit: { featureGroup: drawnItems } }).addTo(map);

      // Drawing event handlers
      map.on(L.Draw.Event.CREATED, function(e) {
        const layer = e.layer;
        drawnItems.addLayer(layer);
        updateDistanceDisplay();
      });

      map.on(L.Draw.Event.EDITED, function(e) { updateDistanceDisplay(); });
      map.on(L.Draw.Event.DELETED, function(e) { updateDistanceDisplay(); });

      // Distance calc using turf (if available)
      function updateDistanceDisplay() {
        let totalKm = 0;
        drawnItems.eachLayer(layer => {
          if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
            const coords = layer.getLatLngs().map(ll => [ll.lng, ll.lat]);
            if (coords.length >= 2 && typeof window.turf !== 'undefined') {
              const line = turf.lineString(coords);
              const length = turf.length(line, { units: 'kilometers' });
              totalKm += length;
            }
          }
        });
        document.getElementById('distance-val').textContent = totalKm.toFixed(2) + ' km';
        
        // Store current distance for route creation
        window.currentRouteDistance = totalKm;
        window.currentRouteGeoJSON = drawnItems.toGeoJSON();
      }

      // Start Route Planning toggle
      const startBtn = document.getElementById('start-route-btn');
      let drawingMode = false;
      let currentPolyline = null;

      startBtn.addEventListener('click', () => {
        if (!drawingMode) {
          // Enable drawing mode
          currentPolyline = new L.Draw.Polyline(map, { 
            shapeOptions: { 
              color: '#dc2626', 
              weight: 4,
              opacity: 0.8
            } 
          });
          currentPolyline.enable();
          startBtn.textContent = '‚èπÔ∏è Stop Drawing';
          startBtn.classList.remove('gray');
          drawingMode = true;
        } else {
          // Disable drawing mode
          if (currentPolyline) {
            currentPolyline.disable();
          }
          startBtn.textContent = '‚úèÔ∏è Draw Route';
          startBtn.classList.add('gray');
          drawingMode = false;
        }
      });

      // Locate
      document.getElementById('locate-btn').addEventListener('click', () => {
        if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
        navigator.geolocation.getCurrentPosition(pos => {
          map.setView([pos.coords.latitude, pos.coords.longitude], 14);
          L.circle([pos.coords.latitude, pos.coords.longitude], { radius: Math.max(30, pos.coords.accuracy/2), color:'#3b82f6', fillOpacity:0.15 }).addTo(map);
        }, err => alert('Unable to retrieve your location: ' + err.message));
      });

      // Export GeoJSON
      document.getElementById('export-geojson').addEventListener('click', () => {
        if (drawnItems.getLayers().length === 0) { 
          alert('No drawn routes to export. Draw a route first!'); 
          return; 
        }
        const geojson = drawnItems.toGeoJSON();
        const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reda-route-${new Date().toISOString().slice(0,10)}.geojson`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      // Clear
      document.getElementById('clear-btn').addEventListener('click', () => {
        if (drawnItems.getLayers().length === 0) {
          alert('No routes to clear.');
          return;
        }
        if (confirm('Remove all drawn routes? This cannot be undone.')) {
          drawnItems.clearLayers();
          updateDistanceDisplay();
          // Stop drawing mode if active
          if (drawingMode) {
            startBtn.click();
          }
        }
      });

      // Try center on user at load
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          map.setView([pos.coords.latitude, pos.coords.longitude], 13);
        }, () => {});
      }

      // keyboard shortcut R toggles draw mode
      document.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'r' && !e.metaKey && !e.ctrlKey) startBtn.click(); });

      // final console log
      console.log('Map initialized successfully.');
    });
  </script>
</body>
</html>
