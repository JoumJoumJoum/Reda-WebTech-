<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReDa Map â€” Automatic Start/End</title>

  <!-- Tailwind & font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

  <style>
    html,body { height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; }
    #map { width:100%; height:100vh; }
    .map-topbar { position:absolute; left:12px; top:12px; z-index:1000; }
    .map-controls { position:absolute; right:12px; top:12px; z-index:1000; display:flex; flex-direction:column; gap:8px; }
    .info-box { position:absolute; left:12px; bottom:12px; z-index:999; background:rgba(255,255,255,0.95); padding:12px 14px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,0.08); font-size:13px; max-width:320px; }
    .btn { background:#dc2626; color:white; padding:10px 14px; border-radius:8px; font-weight:600; border:none; cursor:pointer; font-size:13px; transition:all 0.12s ease; }
    .btn.gray { background:#f3f4f6; color:#111827; }
    .btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(220,38,38,0.3); }
    @media(max-width:640px){
      .map-topbar{left:8px;top:8px;}
      .map-controls{right:8px;top:8px;}
      .btn{padding:8px 12px;font-size:12px;}
      .info-box{left:8px;bottom:8px;max-width:calc(100vw - 32px);font-size:12px;}
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="map-topbar">
    <div class="p-3 bg-white rounded-xl shadow-md flex gap-2 items-center">
      <button id="locate-btn" class="btn gray">ğŸ“ My Location</button>
      <button id="start-route-btn" class="btn">âœï¸ Draw Route</button>
      <button id="clear-btn" class="btn gray">ğŸ—‘ï¸ Clear</button>
    </div>
  </div>

  <div class="map-controls">
    <div class="p-3 bg-white rounded-xl shadow-md text-sm">
      <div><strong>ğŸ“ Distance</strong></div>
      <div class="text-red-600 font-bold text-lg" id="distance-val">0.00 km</div>
      <hr class="my-2">
      <div style="font-size:12px;">
        <div><strong>Start:</strong> <span id="start-name">â€”</span></div>
        <div><strong>End:</strong> <span id="end-name">â€”</span></div>
      </div>
    </div>
  </div>

  <div class="info-box">
    <strong>ğŸ—ºï¸ Quick Tips:</strong>
    <ul class="mt-2 space-y-1 text-xs">
      <li>ğŸ” Use the search box (top-left) to find locations</li>
      <li>âœï¸ Click <b>Draw Route</b> then click on the map to trace your path</li>
      <li>ğŸ“Œ Double-click or press Enter to finish</li>
      <li>ğŸ Start and End points are auto-named from nearby landmarks</li>
      <li>âŒ¨ï¸ Press R to toggle Draw mode</li>
    </ul>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const map = L.map('map').setView([20.5937,78.9629],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(map);
    L.Control.geocoder({defaultMarkGeocode:true}).addTo(map);

    const drawnItems = new L.FeatureGroup().addTo(map);
    new L.Control.Draw({draw:false,edit:{featureGroup:drawnItems}}).addTo(map);

    const startMarker=L.marker([0,0],{icon:L.divIcon({className:'',html:'<div style="background:#10b981;color:#fff;padding:6px 8px;border-radius:8px;font-weight:700;">Start</div>'})});
    const endMarker=L.marker([0,0],{icon:L.divIcon({className:'',html:'<div style="background:#ef4444;color:#fff;padding:6px 8px;border-radius:8px;font-weight:700;">End</div>'})});

    const startNameEl=document.getElementById('start-name');
    const endNameEl=document.getElementById('end-name');
    const distEl=document.getElementById('distance-val');

    async function reverseName(lat,lon){
      const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&namedetails=1`;
      try{
        const r=await fetch(url,{headers:{'Accept':'application/json'}});
        const j=await r.json();
        if(j.namedetails?.name) return j.namedetails.name;
        if(j.name) return j.name;
        if(j.display_name) return j.display_name.split(',')[0];
        const a=j.address||{};
        return a.road||a.neighbourhood||a.city||`${lat.toFixed(4)},${lon.toFixed(4)}`;
      }catch(e){console.warn('Reverse fail',e);return `${lat.toFixed(4)},${lon.toFixed(4)}`;}
    }

    function updateDistance(){
      let km=0;
      drawnItems.eachLayer(l=>{
        if(l instanceof L.Polyline && !(l instanceof L.Polygon)){
          const coords=l.getLatLngs().map(p=>[p.lng,p.lat]);
          if(coords.length>=2){ km+=turf.length(turf.lineString(coords),{units:'kilometers'}); }
        }
      });
      distEl.textContent=km.toFixed(2)+' km';
    }

    // draw route toggle
    const drawBtn=document.getElementById('start-route-btn');
    let drawing=false,handler=null;
    drawBtn.onclick=()=>{
      if(!drawing){
        handler=new L.Draw.Polyline(map,{shapeOptions:{color:'#dc2626',weight:4}}).enable();
        drawBtn.textContent='â¹ï¸ Stop Drawing';
        drawing=true;
      }else{
        if(handler?.disable) handler.disable();
        drawBtn.textContent='âœï¸ Draw Route';
        drawing=false;
      }
    };

    map.on(L.Draw.Event.CREATED,async e=>{
      const layer=e.layer;
      drawnItems.addLayer(layer);
      updateDistance();
      const pts=layer.getLatLngs();
      if(pts.length>=2){
        const s=pts[0],f=pts[pts.length-1];
        startMarker.setLatLng(s).addTo(map);
        endMarker.setLatLng(f).addTo(map);
        startNameEl.textContent='Looking up...';
        endNameEl.textContent='Looking up...';
        const [sName,fName]=await Promise.all([reverseName(s.lat,s.lng),reverseName(f.lat,f.lng)]);
        startNameEl.textContent=sName;
        endNameEl.textContent=fName;
        startMarker.bindPopup(`<b>Start</b><br>${sName}`);
        endMarker.bindPopup(`<b>End</b><br>${fName}`);
      }
      if(drawing){ handler?.disable(); drawBtn.textContent='âœï¸ Draw Route'; drawing=false; }
    });

    map.on(L.Draw.Event.EDITED,updateDistance);
    map.on(L.Draw.Event.DELETED,updateDistance);

    document.getElementById('locate-btn').onclick=()=>{
      if(!navigator.geolocation){alert('Geolocation not supported');return;}
      navigator.geolocation.getCurrentPosition(p=>{
        map.setView([p.coords.latitude,p.coords.longitude],14);
        L.circle([p.coords.latitude,p.coords.longitude],{radius:p.coords.accuracy/2,color:'#3b82f6',fillOpacity:0.15}).addTo(map);
      },err=>alert('Location error: '+err.message));
    };

    document.getElementById('clear-btn').onclick=()=>{
      if(!drawnItems.getLayers().length){alert('Nothing to clear.');return;}
      if(!confirm('Clear all routes and markers?'))return;
      drawnItems.clearLayers();updateDistance();
      map.removeLayer(startMarker);map.removeLayer(endMarker);
      startNameEl.textContent=endNameEl.textContent='â€”';
    };

    // center on user at load
    if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>map.setView([p.coords.latitude,p.coords.longitude],13));}
    document.addEventListener('keydown',e=>{if(e.key.toLowerCase()==='r'&&!e.ctrlKey&&!e.metaKey)drawBtn.click();});
  });
  </script>
</body>
</html>
